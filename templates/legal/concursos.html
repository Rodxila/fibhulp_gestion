{% extends 'base.html' %}
{% block title %}Concursos P√∫blicos{% endblock %}
{% load widget_tweaks %}
{% load formatos %}

{% block content %}

<h1 class="text-3xl font-bold text-purple-700 text-center mt-6 mb-6">Concursos P√∫blicos</h1>
<div class="flex justify-center mb-6 space-x-2">
  <a href="{% url 'legal_convocatorias' %}"
     class="px-4 py-2 rounded-t {% if request.path == '/legal/convocatorias/' %}bg-purple-600 text-white font-semibold shadow{% else %}bg-purple-100 text-purple-700 hover:bg-purple-200{% endif %}">
     Convocatorias
  </a>
  <a href="{% url 'legal_concursos' %}"
     class="px-4 py-2 rounded-t {% if request.path == '/legal/concursos/' %}bg-purple-600 text-white font-semibold shadow{% else %}bg-purple-100 text-purple-700 hover:bg-purple-200{% endif %}">
     Concursos
  </a>
</div>

{% if alertas_hoy %}
  <div class="bg-white-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-6 max-w-4xl mx-auto shadow-lg rounded">
    <strong class="font-bold">‚ö†Ô∏è Alertas importantes:</strong>
    <ul class="list-disc ml-6 mt-2">
      {% for alerta in alertas_hoy %}
        <li>{{ alerta }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}

<!-- üìÅ Formulario de Excel -->
<form method="post" enctype="multipart/form-data" class="mb-6 p-4 bg-white rounded shadow max-w-3xl mx-auto">
  {% csrf_token %}
  <label class="block font-semibold mb-2">Subir Excel</label>
  <input type="file" name="excel_file" accept=".xlsx" class="border p-2 rounded w-full mb-4">
  <button type="submit" class="bg-orange-600 text-white py-2 px-4 rounded hover:bg-orange-700">Importar Excel</button>
</form>

<!-- üìù Formulario para a√±adir concurso manualmente -->
<form method="post" action="" class="max-w-5xl mx-auto my-10 bg-white p-6 rounded shadow space-y-6">
  {% csrf_token %}
  <h2 class="text-xl font-semibold text-purple-700 text-center mb-4">A√±adir Concurso Manualmente</h2>
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
    {% for field in form %}
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">{{ field.label }}</label>
        {{ field|add_class:"w-full p-2 border border-gray-300 rounded bg-gray-50 text-sm" }}
        {% if field.errors %}
          <p class="text-red-500 text-xs mt-1">{{ field.errors|striptags }}</p>
        {% endif %}
      </div>
    {% endfor %}
  </div>
  <div class="text-center">
    <button type="submit" class="mt-4 bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition duration-200">
      A√±adir Concurso
    </button>
  </div>
</form>

<div class="max-w-screen-xl mx-auto mt-8 overflow-x-auto shadow-lg rounded">
  <table id="tablaConcursos" class="w-full border border-gray-300 text-sm text-left">
    <thead class="bg-purple-100 text-gray-700">
      <tr>
        <th class="p-2 border">N.¬∫ EXPED</th>
        <th class="p-2 border">PROCEDIMIENTO</th>
        <th class="p-2 border">TIPOLOG√çA</th>
        <th class="p-2 border">FECHA FIRMA</th>
        <th class="p-2 border">DURACI√ìN CONTRATO</th>
        <th class="p-2 border">FECHA FIN</th>
        <th class="p-2 border">¬øPR√ìRROGAS?</th>
        <th class="p-2 border">FECHA FIN PR√ìRROGA</th>
        <th class="p-2 border">CANTIDAD ECON√ìMICA M√ÅX</th>
        <th class="p-2 border">ESTADO</th>
        <th class="p-2 border">ESTADO CONTINUACION</th>
        <th class="p-2 border">ACCIONES</th>
      </tr>
    </thead>
    <tbody class="bg-white">
      {% for c in concursos %}
        {% if editar_id == c.id|stringformat:"s" %}
          <tr class="bg-blue-50">
            <td class="p-2">{{ c.EXPEDIENTE }}</td>
            <td class="p-2"><input name="procedimiento" value="{{ c.PROCEDIMIENTO }}" class="w-full border p-1 rounded"></td>
            <td class="p-2"><select name="tipologia" class="w-full border p-1 rounded">{% for op in tipologias %}<option value="{{ op }}" {% if c.TIPOLOG√çA == op %}selected{% endif %}>{{ op }}</option>{% endfor %}</select></td>
            <td class="p-2"><input name="fecha_firma" value="{{ c.FECHA_FIRMA }}" class="w-full border p-1 rounded"></td>
            <td class="p-2"><input name="duracion" value="{{ c.DURACI√ìN_CONTRATO }}" class="w-full border p-1 rounded"></td>
            <td class="p-2"><input name="fecha_fin" value="{{ c.FECHA_FIN }}" class="w-full border p-1 rounded"></td>
            <td class="p-2"><select name="prorroga" class="w-full border p-1 rounded">{% for op in prorrogas %}<option value="{{ op }}" {% if c.PRORROGA == op %}selected{% endif %}>{{ op }}</option>{% endfor %}</select></td>
            <td class="p-2"><input name="fecha_fin_prorroga" value="{{ c.FECHA_FIN_PRORROGA }}" class="w-full border p-1 rounded"></td>
            <td class="p-2"><input name="cantidad" type="number" step="0.01" value="{{ c.CANTIDAD_ECONOMICA_MAX }}" class="w-full border p-1 rounded"></td>
            <td class="p-2"><select name="estado" class="w-full border p-1 rounded">{% for op in estados %}<option value="{{ op }}" {% if c.ESTADO == op %}selected{% endif %}>{{ op }}</option>{% endfor %}</select></td>
            <td class="p-2"><input name="estado_continuacion" value="{{ c.ESTADO_CONTINUACION }}" class="w-full border p-1 rounded"></td>
            <td class="p-2 flex flex-col gap-2">
              <button class="btn-guardar bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" data-id="{{ c.id }}">Guardar</button>
              <a href="{{ request.path }}" class="text-sm text-gray-500 underline">Cancelar</a>
            </td>
          </tr>
        {% else %}
          <tr>
            <td class="p-2">{{ c.EXPEDIENTE }}</td>
            <td class="p-2">{{ c.PROCEDIMIENTO }}</td>
            <td class="p-2">{{ c.TIPOLOG√çA }}</td>
            <td class="p-2">{{ c.FECHA_FIRMA }}</td>
            <td class="p-2">{{ c.DURACI√ìN_CONTRATO }}</td>
            <td class="p-2">{{ c.FECHA_FIN }}</td>
            <td class="p-2">{{ c.PRORROGA }}</td>
            <td class="p-2">{{ c.FECHA_FIN_PRORROGA }}</td>
            <td class="p-2">{{ c.CANTIDAD_ECONOMICA_MAX|formato_europeo }} ‚Ç¨</td>
            <td class="p-2">{{ c.ESTADO }}</td>
            <td class="p-2">{{ c.ESTADO_CONTINUACION }}</td>
            <td class="p-2 flex flex-col gap-2">
              <a href="?editar={{ c.id }}" class="bg-purple-600 text-white px-3 py-1 rounded hover:bg-purple-700">Editar</a>
              <a href="{% url 'borrar_concurso' c.id %}" onclick="return confirm('¬øSeguro?')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Borrar</a>
            </td>
          </tr>
        {% endif %}
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="max-w-screen-xl mx-auto mt-6 mb-4 text-center">
  <a href="{% url 'exportar_concursos_excel' %}" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition duration-200 text-sm">
    Exportar a Excel
  </a>
</div>

<h2 class="text-2xl font-bold text-purple-700 mt-16 text-center">Calendario de Contratos y Alertas</h2>
<div id="calendario" class="mt-6 max-w-screen-xl mx-auto p-4 bg-white rounded shadow"></div>

<h2 class="text-2xl font-bold text-purple-700 mt-16 text-center">Gr√°ficos de Concursos</h2>
<div class="space-y-12 max-w-4xl mx-auto mt-10">
  <div class="bg-white rounded shadow p-4">
    <h3 class="text-lg font-semibold text-center mb-4 text-purple-600">Por Procedimiento</h3>
    <div class="h-[600px]">
      <canvas id="graficoProcedimiento" class="w-full h-full"></canvas>
    </div>
  </div>
  <div class="bg-white rounded shadow p-4">
    <h3 class="text-lg font-semibold text-center mb-4 text-purple-600">Por Tipolog√≠a</h3>
    <div class="h-[300px]">
      <canvas id="graficoTipologia" class="w-full h-full"></canvas>
    </div>
  </div>
  <div class="bg-white rounded shadow p-4">
    <h3 class="text-lg font-semibold text-center mb-4 text-purple-600">Evoluci√≥n Anual</h3>
    <div class="h-[300px]">
      <canvas id="graficoAnual" class="w-full h-full"></canvas>
    </div>
  </div>
  <div class="bg-white rounded shadow p-4">
    <h3 class="text-lg font-semibold text-center mb-4 text-purple-600">Concursos por Estado</h3>
    <div class="h-[300px]">
      <canvas id="graficoEstado" class="w-full h-full"></canvas>
    </div>
  </div>
</div>

<!-- Scripts -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      document.cookie.split(';').forEach(cookie => {
        cookie = cookie.trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        }
      });
    }
    return cookieValue;
  }

  $(document).ready(function () {
    $('#tablaConcursos').DataTable({
      language: {
        url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json'
      },
      order: [[0, 'asc']],
      pageLength: 50,
      drawCallback: function(settings) {
        $('#tablaConcursos tbody tr').each(function () {
          const estado = $(this).find('td').eq(9).text().trim().toUpperCase();
          $(this).removeClass().addClass('bg-white');
          if (estado.includes("ACTIVO")) {
            $(this).addClass('bg-blue-100');
          } else if (estado.includes("FINALIZADO")) {
            $(this).addClass('bg-green-100');
          } else if (estado.includes("PARALIZADO")) {
            $(this).addClass('bg-yellow-100');
          } else if (estado.includes("CANCELADO")) {
            $(this).addClass('bg-red-200');
          } else if (estado.includes("DESIERTO Y FINALIZADO")) {
            $(this).addClass('bg-red-200');
          } else if (estado.includes("DESIERTO")) {
            $(this).addClass('bg-red-100');
          } else if (estado.includes("EN GESTI√ìN")) {
            $(this).addClass('bg-orange-100');
          }
        });
      }
    });

    $('.btn-guardar').click(function () {
      const $row = $(this).closest('tr');
      const data = { editar_id: $(this).data('id') };
      $row.find('input, select').each(function () {
        data[$(this).attr('name')] = $(this).val();
      });
      $.ajax({
        url: "{% url 'legal_concursos' %}",
        type: 'POST',
        data: data,
        headers: { 'X-CSRFToken': getCookie('csrftoken') },
        success: () => window.location.href = window.location.pathname,
        error: xhr => alert("Error: " + xhr.status + "\n" + xhr.responseText)
      });
    });

    // Gr√°ficos
    new Chart(document.getElementById('graficoProcedimiento'), {
      type: 'bar',
      data: {
        labels: {{ grafico_procedimiento.labels|safe }},
        datasets: [{
          label: '‚Ç¨ por Procedimiento',
          data: {{ grafico_procedimiento.values|safe }},
          backgroundColor: '#9333ea',
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('graficoTipologia'), {
      type: 'pie',
      data: {
        labels: {{ grafico_tipologia.labels|safe }},
        datasets: [{
          label: '‚Ç¨ por Tipolog√≠a',
          data: {{ grafico_tipologia.values|safe }},
          backgroundColor: ['#fbbf24', '#34d399', '#60a5fa', '#ec4899'],
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('graficoAnual'), {
      type: 'line',
      data: {
        labels: {{ grafico_anual.labels|safe }},
        datasets: [{
          label: 'Evoluci√≥n Anual ‚Ç¨',
          data: {{ grafico_anual.values|safe }},
          borderColor: '#10b981',
          fill: false,
        }]
      },
      options: { responsive: true, maintainAspectRatio: false }
    });

    new Chart(document.getElementById('graficoEstado'), {
      type: 'bar',
      data: {
        labels: {{ grafico_estado.labels|safe }},
        datasets: [{
          label: 'N√∫mero de Concursos',
          data: {{ grafico_estado.values|safe }},
          backgroundColor: '#3b82f6',
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              precision: 0
            }
          }
        }
      }
    });

    // Calendario
    var calendarEl = document.getElementById('calendario');
    var calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      events: {{ eventos|safe }}
    });
    calendar.render();
  });
</script>
{% endblock %}
