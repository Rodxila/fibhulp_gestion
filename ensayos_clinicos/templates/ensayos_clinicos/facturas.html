{% extends 'base.html' %}
{% block title %}Facturas - FIBHULP{% endblock %}
{% block content %}
{% load static %}
{% load custom_filters %}

{% if messages %}
  <div class="max-w-md mx-auto mb-4">
    {% for message in messages %}
      <div class="p-3 rounded shadow text-white
                  {% if message.tags == 'success' %}bg-green-600
                  {% elif message.tags == 'warning' %}bg-yellow-500
                  {% elif message.tags == 'error' %}bg-red-600
                  {% else %}bg-gray-600{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}
<!-- jQuery (necesario para DataTables) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- DataTables -->
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- DataTables idioma español -->
<script src="https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"></script>

<form method="post" enctype="multipart/form-data" class="bg-white p-6 rounded shadow mb-12">
  {% csrf_token %}
  <h1 class="text-3xl mb-5 text-center">Ensayos Clínicos</h1>

  <div class="flex justify-center mb-6 space-x-2">
    <a href="/ensayos-clinicos/contratos/"
       class="px-4 py-2 rounded-t bg-purple-100 text-purple-700 hover:bg-purple-200">Contratos</a>
    <a href="/ensayos-clinicos/facturas/"
       class="px-4 py-2 rounded-t bg-purple-600 text-white font-semibold shadow">Facturas</a>
  </div>

  <label class="block mb-2 font-semibold">Objetivo de facturación (€)</label>
  <input name="meta" type="number" min="0" step="0.01" value="{{ meta|default:0 }}" class="w-full border p-2 rounded mb-4" required />

  <label class="block mb-2 font-semibold">Año</label>
  <input name="año" type="number" min="2000" max="2100" step="1" value="{{ año }}" class="w-full border p-2 rounded mb-4" required />

  <div class="grid grid-cols-2 gap-4 text-sm">
    {% for mes in meses %}
      <div>
        <label class="block font-semibold">{{ mes }}</label>
        {% if mensual %}
          {% with datos=mensual|dict_get:mes %}
            <input name="{{ mes }}" type="number" min="0" step="0.01" value="{{ datos.cantidad|default_if_none:'' }}" class="w-full border p-1 rounded mb-2" placeholder="Importe (€)" />
            <input name="n_{{ mes }}" type="number" min="0" step="1" value="{{ datos.n|default_if_none:'' }}" class="w-full border p-1 rounded" placeholder="Nº facturas" />
          {% endwith %}
        {% else %}
          <input name="{{ mes }}" type="number" min="0" step="0.01" value="" class="w-full border p-1 rounded mb-2" placeholder="Importe (€)" />
          <input name="n_{{ mes }}" type="number" min="0" step="1" value="" class="w-full border p-1 rounded" placeholder="Nº facturas" />
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <button class="w-full bg-blue-600 text-white py-2 mt-4 rounded">Actualizar</button>

  <label for="archivo_excel" class="block font-semibold mt-6 mb-1">Subir Excel de facturas (.xlsx)</label>
  <input type="file" name="archivo_excel" accept=".xlsx" class="w-full border p-2 rounded mb-2" />
  <button type="submit" name="subir_excel" value="1" class="w-full bg-orange-600 text-white py-2 rounded hover:bg-orange-700">Importar desde Excel</button>

  <button type="button" onclick="openDeleteModal()" class="w-full bg-red-600 text-white py-2 mt-2 rounded">Borrar año</button>
  <a href="{% url 'exportar_facturas_excel' %}" class="w-full bg-green-600 text-white py-2 mt-2 rounded text-center block hover:bg-green-700">Exportar a Excel</a>
  <button type="button" onclick="openCompararModal()" class="w-full bg-purple-700 text-white py-2 mt-2 rounded hover:bg-purple-800">Comparar años</button>

  {% if total %}
    <p class="mt-4 text-sm text-center text-gray-600">
      Has alcanzado el {{ progreso }}% del objetivo con un total de €{{ total|formato_europeo }}.
    </p>
    <div class="w-full bg-gray-200 rounded-full h-4 mt-2">
      <div class="bg-blue-600 h-4 rounded-full" style="width: {{ progreso }}%"></div>
    </div>
  {% endif %}
</form>




<h2 class="text-xl font-semibold text-purple-800 mb-4 mt-12 text-center">Facturas Detalladas</h2>

<div class="overflow-x-auto mb-10">
  <table id="facturaDetalleTable" class="w-full text-sm text-left border border-gray-300">
    <thead class="bg-purple-200 text-purple-800">
      <tr>
        <th class="p-2 border">Año</th>
        <th class="p-2 border">Mes</th>
        <th class="p-2 border">Identificador</th>
        <th class="p-2 border">Cantidad (€)</th>
        <th class="p-2 border">Fecha Último Cobro</th>
      </tr>
    </thead>
    <tbody>
      {% for f in facturas_detalle %}
        <tr class="border-t">
          <td class="p-2 text-center">{{ f.año }}</td>
          <td class="p-2 text-center">{{ f.mes }}</td>
          <td class="p-2">{{ f.identificador }}</td>
          <td class="p-2 text-right">€{{ f.cantidad|formato_europeo }}</td>
          <td class="p-2 text-center">
            {% if f.fecha_ultimo_cobro %}
              {{ f.fecha_ultimo_cobro|date:"d/m/Y" }}
            {% else %}
              <span class="text-gray-400 italic">Sin fecha</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>





<!-- Bloques por año -->
{% for bloque in bloques_facturas %}
  <div class="mb-12">
    <h2 class="text-2xl text-center font-bold text-purple-800">Año {{ bloque.año }}</h2>
    <canvas id="facturaChart_{{ bloque.año }}" class="my-6"></canvas>

    <div class="mt-4 bg-white p-4 rounded shadow max-w-2xl mx-auto">
      <h3 class="text-lg font-semibold mb-4 text-purple-700 text-center">Resumen mensual</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
        {% for mes in meses %}
          {% with bloque.mensual|get_item:mes as datos %}
            <div>
              <p class="font-semibold">{{ mes }}</p>
              <p class="text-green-700 text-sm">Total: €{{ datos.cantidad|formato_europeo }}</p>
              <p class="text-blue-700 text-sm">Media: €{{ bloque.medias|index:forloop.counter0|formato_europeo }}</p>
            </div>
          {% endwith %}
        {% endfor %}
      </div>
      <p class="mt-6 text-center font-semibold text-purple-800 text-base">
        Total anual: €{{ bloque.total|formato_europeo }}
      </p>
    </div>


  </div>
{% endfor %}

{% if comparacion %}
  <div class="mb-12 mt-12 bg-white p-6 rounded shadow">
    <h2 class="text-2xl text-center font-bold text-indigo-700 mb-4">
      Comparativa {{ comparacion.año_1 }} vs {{ comparacion.año_2 }}
    </h2>
    <canvas id="comparacionChart" height="120"></canvas>
  </div>

  <script>
    const comparacionData = {
      labels: {{ comparacion.labels|safe }},
      datasets: [
        {
          label: '{{ comparacion.año_1 }}',
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          data: {{ comparacion.valores_1|safe }},
        },
        {
          label: '{{ comparacion.año_2 }}',
          backgroundColor: 'rgba(153, 102, 255, 0.6)',
          data: {{ comparacion.valores_2|safe }},
        }
      ]
    };

    new Chart(document.getElementById("comparacionChart").getContext('2d'), {
      type: 'bar',
      data: comparacionData,
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
              }
            }
          }
        }
      }
    });
  </script>
{% endif %}

<!-- Renderizar gráficos -->
<script>
  const chartData = {{ bloques_facturas_json|safe }};
  chartData.forEach(bloque => {
    const ctx = document.getElementById(`facturaChart_${bloque.año}`).getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: bloque.chart_data.labels,
        datasets: [{
          label: 'Facturación mensual (€)',
          data: bloque.chart_data.valores,
          backgroundColor: 'rgba(99, 102, 241, 0.6)',
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            ticks: {
              callback: function(value) {
                return value.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + " €";
              }
            }
          }
        }
      }
    });
  });
</script>

<!-- Modales -->
<!-- Comparar -->
<div id="compararModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-lg">
    <h2 class="text-xl font-semibold mb-4 text-purple-700">Comparar años</h2>
    <form method="get" action="{% url 'facturas' %}">
      <label class="block font-semibold mb-1">Año 1</label>
      <select name="comparar_ano_1" class="w-full border p-2 rounded mb-4" required>
        <option value="">-- Selecciona año --</option>
        {% for bloque in bloques_facturas %}
          <option value="{{ bloque.año }}">{{ bloque.año }}</option>
        {% endfor %}
      </select>

      <label class="block font-semibold mb-1">Año 2</label>
      <select name="comparar_ano_2" class="w-full border p-2 rounded mb-4" required>
        <option value="">-- Selecciona año --</option>
        {% for bloque in bloques_facturas %}
          <option value="{{ bloque.año }}">{{ bloque.año }}</option>
        {% endfor %}
      </select>

      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeCompararModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700">Comparar</button>
      </div>
    </form>
  </div>
</div>

<!-- Confirmar eliminación -->
<div id="deleteModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 hidden z-50">
  <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-lg">
    <h2 class="text-xl font-semibold mb-4 text-red-600">Confirmar eliminación</h2>
    <p class="mb-2">Introduce el año que deseas eliminar para confirmar:</p>
    <p class="mb-4 text-sm text-gray-600">
      Año actual visible en el formulario: <span id="currentYear" class="font-semibold text-purple-700"></span>
    </p>
    <form method="post" onsubmit="return validateDeleteYear()">
      {% csrf_token %}
      <input id="confirmYearInput" name="año" type="number" class="w-full border p-2 rounded mb-4" placeholder="Introduce el año a eliminar" required>
      <input type="hidden" name="delete-year" value="1">
      <div class="flex justify-end gap-2">
        <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded hover:bg-gray-400">Cancelar</button>
        <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">Borrar</button>
      </div>
    </form>
  </div>
</div>

<script>
  function openDeleteModal() {
    const añoFormulario = document.querySelector('input[name="año"]').value;
    document.getElementById('currentYear').innerText = añoFormulario;
    document.getElementById('confirmYearInput').value = "";
    document.getElementById('deleteModal').classList.remove('hidden');
  }

  function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
  }

  function validateDeleteYear() {
    const original = document.querySelector('input[name="año"]').value;
    const typed = document.getElementById('confirmYearInput').value;
    if (original !== typed) {
      alert("El año ingresado no coincide con el año del formulario. No se ha eliminado nada.");
      return false;
    }
    return true;
  }

  function openCompararModal() {
    document.getElementById('compararModal').classList.remove('hidden');
  }

  function closeCompararModal() {
    document.getElementById('compararModal').classList.add('hidden');
  }

</script>


<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var tabla = $('#facturaDetalleTable').DataTable({
      language: {
        url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
      },
      order: [[0, "desc"], [1, "asc"]],
      initComplete: function () {
        const api = this.api();

        // Año
        document.getElementById('filtroAño').addEventListener('change', function () {
          api.column(0).search(this.value).draw();
        });

        // Mes
        document.getElementById('filtroMes').addEventListener('change', function () {
            debugger
          api.column(1).search(this.value).draw();
        });

        // Identificador
        document.getElementById('filtroIdentificador').addEventListener('input', function () {
          api.column(2).search(this.value).draw();
        });

        // Concepto (requiere que se incluya en la tabla como columna visible o con .data())
        const conceptoInput = document.getElementById('filtroConcepto');
        if (conceptoInput) {
          conceptoInput.addEventListener('input', function () {
            api.column(3).search(this.value).draw();
          });
        }

        // Filtro global
        document.getElementById('busquedaGlobal').addEventListener('input', function () {
          api.search(this.value).draw();
        });
      }
    });
  });
</script>


{% endblock %}
